{% extends 'archivos/base.html' %}
{% block title %}Importar Datos{% endblock %}
{% block content %}
{% load static %}

<div class="container mt-4">

  {% if messages %}
    {% for m in messages %}
      <div class="alert alert-{{ m.tags }} py-1 mb-2">{{ m }}</div>
    {% endfor %}
  {% endif %}

  {% if step == 1 %}
    <h4>Paso 1: Seleccionar origen</h4>
    <form method="post" enctype="multipart/form-data" class="mt-3" id="form-origen">
      {% csrf_token %}

      <div class="mb-3">
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="modo_origen" id="modo_local" value="local"
                 {% if not request.POST.modo_origen or request.POST.modo_origen == 'local' %}checked{% endif %}
                 onclick="toggleOrigen()">
          <label class="form-check-label" for="modo_local">Subir archivo local</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="modo_origen" id="modo_compartido" value="compartido"
                 {% if request.POST.modo_origen == 'compartido' %}checked{% endif %}
                 onclick="toggleOrigen()">
          <label class="form-check-label" for="modo_compartido">Desde carpeta compartida</label>
        </div>
      </div>

      <div id="origen_local" class="{% if request.POST.modo_origen == 'compartido' %}d-none{% endif %}">
        <div class="mb-3">
          <input class="form-control" type="file" name="archivo_fuente" accept=".sql,.csv,.xlsx,.xls">
          <small class="text-muted">Soportados: .sql, .xlsx, .xls, .csv</small>
        </div>
      </div>

      <div id="origen_compartido" class="{% if not request.POST.modo_origen or request.POST.modo_origen == 'local' %}d-none{% endif %}">
        <div class="mb-2">
          <label class="form-label">Ruta carpeta compartida (UNC)</label>
          <input type="text" class="form-control form-control-sm" name="ruta_compartida" id="ruta_compartida"
                placeholder="\\SERVIDOR\\recurso\\subcarpeta"
                value="{{ request.POST.ruta_compartida }}">
        </div>
                {% comment %} Previsualizar archivo {% endcomment %}
      <div class="mt-2 mb-3">
        <button type="button" class="btn btn-info" id="btn_previsualizar">
          <i class="bi bi-eye"></i> Previsualizar Archivo SQL
        </button>
        <div class="mt-2 alert alert-info" id="cargando" style="display:none;">
          <i class="bi bi-hourglass-split"></i> Cargando estructura del archivo SQL...
        </div>
        <div class="mt-2" id="preview_result"></div>
      </div>
    </div>
        



      <div class="form-check mb-2">
        <input class="form-check-input" type="checkbox" id="gp" name="guardar_proceso"
               {% if request.POST.guardar_proceso %}checked{% endif %}>
        <label class="form-check-label" for="gp">
          Guardar como proceso reutilizable (para .sql)
        </label>
      </div>
      <div class="mb-3">
        <input type="text" class="form-control form-control-sm" name="nombre_proceso" id="nombre_proceso_input"
               placeholder="Nombre del proceso (opcional)" value="{{ request.POST.nombre_proceso }}" {% if not request.POST.guardar_proceso %}disabled aria-disabled="true"{% endif %} aria-label="Nombre del proceso">
        <small class="text-muted" id="nombreProcesoHelp">Se habilita al marcar "Guardar como proceso".</small>
      </div>

      <button class="btn btn-primary" name="accion" value="subir_archivo">Continuar</button>
    </form>

<!-- Donde está actualmente el script del botón de previsualizar -->
<!-- Añade esto al final del archivo, antes del cierre del bloque content -->
<script>
  // Una única función toggleOrigen
  function toggleOrigen() {
    const local = document.getElementById('modo_local').checked;
    document.getElementById('origen_local').classList.toggle('d-none', !local);
    document.getElementById('origen_compartido').classList.toggle('d-none', local);
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Inicializa estado de visibilidad
    toggleOrigen();
    
    // Conecta el evento del botón previsualizar
    const btnPrevisualizar = document.getElementById('btn_previsualizar');
    const cargando = document.getElementById('cargando');
    const previewResult = document.getElementById('preview_result');
    
    if (btnPrevisualizar) {
      btnPrevisualizar.addEventListener('click', function() {
        const ruta = document.getElementById('ruta_compartida').value.trim();
        const archivo = document.getElementById('nombre_archivo').value.trim();
        
        if (!ruta || !archivo) {
          previewResult.innerHTML = '<div class="alert alert-warning">Por favor, ingresa la ruta y el nombre del archivo.</div>';
          return;
        }
        
        if (!archivo.toLowerCase().endsWith('.sql')) {
          previewResult.innerHTML = '<div class="alert alert-warning">El archivo debe tener extensión .sql</div>';
          return;
        }
        
        // Mostrar indicador de carga
        cargando.style.display = 'block';
        previewResult.innerHTML = '';
        
        // Realizar petición AJAX
        fetch('/api/preview-sql-estructura/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify({
            ruta: ruta,
            archivo: archivo
          })
        })
        .then(response => response.json())
        .then(data => {
          cargando.style.display = 'none';
          
          if (!data.ok) {
            previewResult.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            return;
          }
          
          if (!data.tablas || data.tablas.length === 0) {
            previewResult.innerHTML = `<div class="alert alert-warning">No se encontraron tablas en el archivo SQL.</div>`;
            return;
          }
          
          // Guardar datos en localStorage para uso posterior
          localStorage.setItem('sql_preview_data', JSON.stringify(data));
          
          // Mostrar interfaz de selección de tablas y columnas
          let html = `
            <div class="card border-info mb-4">
              <div class="card-header bg-info text-white">
                <h5><i class="bi bi-table"></i> Tablas encontradas en el archivo</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <strong>${data.tablas.length} tabla(s) detectada(s)</strong>
                </div>
                
                <div class="list-group">`;
          
          // Generar un panel para cada tabla
          data.tablas.forEach((tabla, idx) => {
            html += `
              <div class="list-group-item list-group-item-action">
                <div class="form-check mb-2">
                  <input class="form-check-input tabla-select" type="checkbox" id="tabla_${idx}" 
                         name="tablas_seleccionadas" value="${tabla.nombre}" 
                         onchange="toggleTablaDetalle(${idx})">
                  <label class="form-check-label fw-bold" for="tabla_${idx}">
                    ${tabla.nombre}
                  </label>
                  ${tabla.columnas && tabla.columnas.length ? 
                    `<span class="badge bg-info ms-2">${tabla.columnas.length} columna(s)</span>` : ''}
                </div>
                
                <div id="detalle_tabla_${idx}" class="tabla-detalle border-top pt-3 mt-2" style="display: none;">
                  ${tabla.columnas && tabla.columnas.length ? `
                    <div class="mb-2">
                      <button type="button" class="btn btn-sm btn-outline-primary"
                              onclick="togglePreview(${idx})">
                        Mostrar/ocultar datos de muestra
                      </button>
                    </div>
                    
                    <div class="preview-container table-responsive" id="preview_${idx}" style="display: none;">
                      <table class="table table-sm table-striped table-bordered">
                        <thead>
                          <tr>
                            ${tabla.columnas.map(col => `<th>${col}</th>`).join('')}
                          </tr>
                        </thead>
                        <tbody>
                          ${tabla.preview && tabla.preview.map(row => `
                            <tr>
                              ${row.map(cell => `<td>${cell === null ? '' : cell}</td>`).join('')}
                            </tr>
                          `).join('')}
                        </tbody>
                      </table>
                    </div>
                  ` : ''}
                </div>
              </div>`;
          });
          
          html += `
                </div>
              </div>
            </div>`;
          
          previewResult.innerHTML = html;
        })
        .catch(error => {
          cargando.style.display = 'none';
          previewResult.innerHTML = `<div class="alert alert-danger">Error de comunicación: ${error}</div>`;
        });
      });
    }
    // Habilitar/deshabilitar input de nombre proceso
    const chkGuardar = document.getElementById('gp');
    const nombreProceso = document.getElementById('nombre_proceso_input');
    if(chkGuardar && nombreProceso){
      chkGuardar.addEventListener('change',()=>{
        if(chkGuardar.checked){
          nombreProceso.removeAttribute('disabled');
          nombreProceso.setAttribute('aria-disabled','false');
          nombreProceso.focus();
        } else {
          nombreProceso.value='';
          nombreProceso.setAttribute('disabled','disabled');
          nombreProceso.setAttribute('aria-disabled','true');
        }
      });
    }
  });
  
  // Funciones de utilidad para manejo de la interfaz
  function toggleTablaDetalle(idx) {
    const checkbox = document.getElementById(`tabla_${idx}`);
    const detalle = document.getElementById(`detalle_tabla_${idx}`);
    
    if (checkbox.checked) {
      detalle.style.display = 'block';
    } else {
      detalle.style.display = 'none';
    }
  }
  
  function togglePreview(idx) {
    const preview = document.getElementById(`preview_${idx}`);
    preview.style.display = preview.style.display === 'none' ? 'block' : 'none';
  }
</script>



        
    
    


  {% elif step == 2 %}
    <h4>Paso 2: Seleccionar tablas y columnas</h4>
    <div class="mb-3">
      <a href="{% url 'seleccionar_datos' %}?reset=1" class="btn btn-sm btn-outline-danger">Subir otro archivo</a>
    </div>
    {% if tablas_disponibles %}
      <form method="post">
        {% csrf_token %}
        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" id="norm" name="aplicar_normalizacion">
          <label class="form-check-label" for="norm">Normalización básica</label>
        </div>

        <div class="mb-3">
          <button type="button" class="btn btn-sm btn-outline-secondary" onclick="marcar(true)">Marcar todas</button>
          <button type="button" class="btn btn-sm btn-outline-secondary" onclick="marcar(false)">Desmarcar todas</button>
        </div>

        {% for t in tablas_disponibles %}
          <div class="card mb-3">
            <div class="card-body pb-2">
              <div class="d-flex align-items-center gap-3">
                <div class="form-check">
                  <input class="form-check-input tabla-check" type="checkbox" name="tablas" value="{{ t }}" id="tab_{{ t }}" onchange="toggleTabla('{{ t }}')">
                  <label class="form-check-label fw-bold" for="tab_{{ t }}">{{ t }}</label>
                </div>
                <small class="text-muted" id="info_{{ t }}">(sin cargar)</small>
                <div class="ms-auto">
                  <button type="button" class="btn btn-sm btn-outline-primary d-none" id="btnCols_{{ t }}" onclick="toggleCols('{{ t }}')">Cols On/Off</button>
                </div>
              </div>
              <div class="mt-3 d-none" id="panel_{{ t }}">
                <div class="row g-2 mb-2">
                  <div class="col-sm-3">
                    <label class="form-label form-label-sm mb-1">Fila inicio</label>
                    <input type="number" class="form-control form-control-sm" name="fila_inicio_{{ t }}" value="0" min="0">
                  </div>
                  <div class="col-sm-3">
                    <label class="form-label form-label-sm mb-1">Fila fin</label>
                    <input type="number" class="form-control form-control-sm" name="fila_fin_{{ t }}" min="0">
                  </div>
                  <div class="col-sm-4">
                    <label class="form-label form-label-sm mb-1">Nombre final tabla</label>
                    <input type="text" class="form-control form-control-sm" name="nombre_tabla_final_{{ t }}" value="{{ t }}">
                  </div>
                </div>
                <div class="mb-2">
                  <input type="text" class="form-control form-control-sm" placeholder="Filtrar columnas" oninput="filterCols('{{ t }}', this.value)">
                </div>
                <div id="cols_wrap_{{ t }}" class="mb-3"></div>
                <div class="table-responsive small" id="preview_wrap_{{ t }}"></div>
              </div>
            </div>
          </div>
        {% endfor %}
        <button class="btn btn-primary" name="accion" value="procesar_columnas">Guardar en BD</button>
      </form>


    <script src="{% static 'static/js/seleccionar_datos.js' %}"></script>

      
      <script>
        function marcar(state){
          document.querySelectorAll('.tabla-check').forEach(c=>{
            c.checked = state;
            toggleTabla(c.value);
          });
        }
        function toggleTabla(tabla){
          const chk=document.getElementById('tab_'+tabla);
          const panel=document.getElementById('panel_'+tabla);
          if(!chk.checked){ panel.classList.add('d-none'); return; }
          if(panel.dataset.loaded==='1'){ panel.classList.remove('d-none'); return; }
          cargarPreview(tabla);
        }
        function cargarPreview(tabla){
          const info=document.getElementById('info_'+tabla);
          info.textContent='Cargando...';
          fetch(`{% url 'preview_tabla' %}?tabla=${encodeURIComponent(tabla)}`)
            .then(r=>r.json())
            .then(j=>{
              if(!j.ok){ info.textContent='Error: '+j.error; return; }
              info.textContent=`${j.columnas.length} col(s), ${j.data.length} fila(s)`;
              renderCols(tabla,j.columnas);
              renderPreview(tabla,j.columnas,j.data);
              const panel=document.getElementById('panel_'+tabla);
              panel.classList.remove('d-none');
              panel.dataset.loaded='1';
              document.getElementById('btnCols_'+tabla).classList.remove('d-none');
            })
            .catch(()=> info.textContent='Error');
        }
        function renderCols(tabla, columnas){
          const wrap=document.getElementById('cols_wrap_'+tabla);
          wrap.innerHTML='<strong>Columnas:</strong>';
          columnas.forEach(col=>{
            const row=document.createElement('div');
            row.className='row align-items-center mt-1 col-item col-'+tabla;
            row.setAttribute('data-col', col.toLowerCase());
            row.innerHTML=`
              <div class="col-auto">
                <input class="form-check-input col-box-${tabla}" type="checkbox" name="columnas_${tabla}" value="${col}" id="c_${tabla}_${col}" checked>
              </div>
              <div class="col-auto">
                <label class="form-check-label" for="c_${tabla}_${col}">${col}</label>
              </div>
              <div class="col">
                <input type="text" class="form-control form-control-sm" name="rename_${tabla}_${col}" value="${col}">
              </div>`;
            wrap.appendChild(row);
          });
        }
        function renderPreview(tabla, cols, data){
          const wrap=document.getElementById('preview_wrap_'+tabla);
          if(!cols.length){ wrap.innerHTML='<em>Sin datos</em>'; return; }
          let thead='<tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr>';
          let tbody=data.map(r=>'<tr>'+r.map(v=>`<td>${v===null?'':v}</td>`).join('')+'</tr>').join('');
          wrap.innerHTML=`<table class="table table-sm table-bordered mb-0"><thead>${thead}</thead><tbody>${tbody}</tbody></table>`;
        }
        function filterCols(tabla, term){
          const t=term.toLowerCase();
          document.querySelectorAll('#cols_wrap_'+tabla+' .col-item').forEach(item=>{
            const n=item.getAttribute('data-col');
            item.style.display = (!t || n.includes(t)) ? '' : 'none';
          });
        }
      </script>
      <script>
  // Función para mostrar detalles de tabla en modal
  function mostrarDetallesTabla(tabla) {
    const data = JSON.parse(localStorage.getItem('sql_preview_data'));
    const tablaInfo = data.tablas.find(t => t.nombre === tabla);
    
    // Modal HTML
    const modalHTML = `
      <div class="modal fade" id="detallesTablaModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title"><i class="bi bi-table"></i> Tabla: ${tabla}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <h6>Columnas:</h6>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Nombre</th>
                      <th>Tipo</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${tablaInfo.columnas_info?.map(col => `
                      <tr>
                        <td>${col.nombre}</td>
                        <td>${col.tipo || 'N/A'}</td>
                      </tr>
                    `).join('') || '<tr><td colspan="2">Información detallada no disponible</td></tr>'}
                  </tbody>
                </table>
              </div>
              ${tablaInfo.preview ? `
                <h6 class="mt-3">Vista previa de datos:</h6>
                <div class="table-responsive">
                  <table class="table table-sm table-striped">
                    <thead>
                      <tr>
                        ${tablaInfo.columnas?.map(col => `<th>${col}</th>`).join('') || ''}
                      </tr>
                    </thead>
                    <tbody>
                      ${tablaInfo.preview?.map(row => `
                        <tr>
                          ${row.map(cell => `<td>${cell === null ? '' : cell}</td>`).join('')}
                        </tr>
                      `).join('') || ''}
                    </tbody>
                  </table>
                </div>
              ` : ''}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
          </div>
        </div>
      </div>`;
  
    // Insertar modal en el DOM
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHTML;
    document.body.appendChild(modalContainer);
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('detallesTablaModal'));
    modal.show();
    
    // Limpiar el DOM cuando se cierre
    document.getElementById('detallesTablaModal').addEventListener('hidden.bs.modal', function() {
      document.body.removeChild(modalContainer);
    });
  }
</script>
    {% else %}
      <p>No hay tablas detectadas.</p>
    {% endif %}

  {% else %}
    <div class="alert alert-warning">Debug: step inesperado ({{ step|default:'(vacío)' }}). Usa ?reset=1</div>
  {% endif %}

</div>
{% endblock %}