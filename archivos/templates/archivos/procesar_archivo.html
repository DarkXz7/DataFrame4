{% extends 'archivos/base.html' %}
{% load custom_filters %}
{% block title %}Procesando {{ archivo.nombre }} - Gestor de Archivos{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Encabezado con información del procesamiento -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">
                    <i class="bi bi-cpu"></i> Archivo Procesado: {{ archivo.nombre }}
                    {% if hoja_seleccionada %}
                        <small class="ms-2">- Hoja: {{ hoja_seleccionada }}</small>
                    {% endif %}
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6><strong>Información del procesamiento:</strong></h6>
                        <ul class="list-unstyled">
                            <li><strong>Archivo:</strong> {{ archivo.nombre }}</li>
                            <li><strong>Tipo:</strong> 
                                <span class="badge bg-{% if archivo.tipo == 'excel' %}success{% elif archivo.tipo == 'csv' %}info{% else %}warning{% endif %}">
                                    {{ archivo.tipo|upper }}
                                </span>
                            </li>
                            {% if hoja_seleccionada %}
                                <li><strong>Hoja procesada:</strong> {{ hoja_seleccionada }}</li>
                            {% endif %}
                            <li><strong>Procesado el:</strong> {{ archivo_procesado.fecha_procesamiento|date:"d/m/Y H:i:s" }}</li>
                        </ul>
                    </div>
                    <div class="col-md-4 text-end">
                        <h6><strong>Estadísticas:</strong></h6>
                        <p><strong>Total de filas:</strong> <span class="badge bg-primary">{{ total_filas }}</span></p>
                        <p><strong>Columnas:</strong> <span class="badge bg-secondary">{{ archivo_procesado.columnas_totales }}</span></p>
                        <p><strong>Mostrando:</strong> <span class="badge bg-info">{{ mostrando_filas }} filas</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nombres de columnas -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-list"></i> Columnas Detectadas</h6>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-1">
                    {% if columnas_lista %}
                        {% for columna in columnas_lista %}
                            <span class="badge bg-light text-dark border">{{ columna }}</span>
                        {% endfor %}
                    {% else %}
                        {% for columna in archivo_procesado.columnas_nombres|split:", " %}
                            <span class="badge bg-light text-dark border">{{ columna }}</span>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Datos del archivo -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-table"></i> Datos del Archivo</h6>
                <div>
                    {% if total_filas > mostrando_filas %}
                        <span class="badge bg-warning">
                            <i class="bi bi-info-circle"></i> Mostrando {{ mostrando_filas }} de {{ total_filas }} filas
                        </span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;" id="tabla-datos">
                    {{ df_html|safe }}
                </div>
                
                {% if total_filas > mostrando_filas %}
                <div class="text-center mt-3">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Nota:</strong> Se muestran las primeras {{ mostrando_filas }} filas de {{ total_filas }} totales.
                        Para ver más datos, considera exportar el archivo completo.
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Acciones -->
        <div class="card mt-4">
            <div class="card-body">
                <h6><strong>¿Qué quieres hacer ahora?</strong></h6>
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <a href="{% url 'detalle_archivo' archivo.id %}" class="btn btn-outline-primary w-100">
                            <i class="bi bi-arrow-left"></i> Volver al detalle
                        </a>
                    </div>
                    {% if archivo.tipo == 'excel' %}
                    <div class="col-md-3 mb-2">
                        <div class="dropdown w-100">
                            <button class="btn btn-outline-success dropdown-toggle w-100" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-layers"></i> Otra hoja
                            </button>
                            <ul class="dropdown-menu w-100">
                                <li><a class="dropdown-item" href="{% url 'procesar_archivo' archivo.id %}">Primera hoja</a></li>
                                <!-- Aquí se agregarían dinámicamente las otras hojas -->
                            </ul>
                        </div>
                    </div>
                    {% endif %}
                    <div class="col-md-3 mb-2">
                        <a href="{% url 'listar_archivos' archivo.carpeta.id %}" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-files"></i> Otros archivos
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-info w-100" onclick="mostrarInformacionTecnica()">
                            <i class="bi bi-info-circle"></i> Info técnica
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de información técnica (inicialmente oculto) -->
        <div class="card mt-3" id="info-tecnica" style="display: none;">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-code"></i> Información Técnica</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Detalles del archivo:</h6>
                        <ul class="list-unstyled small">
                            <li><strong>Ruta completa:</strong> <code>{{ archivo.ruta_completa }}</code></li>
                            <li><strong>Tamaño:</strong> {{ archivo.tamaño }} bytes</li>
                            <li><strong>Modificado:</strong> {{ archivo.fecha_modificacion|date:"d/m/Y H:i:s" }}</li>
                            <li><strong>Detectado:</strong> {{ archivo.fecha_deteccion|date:"d/m/Y H:i:s" }}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Detalles del procesamiento:</h6>
                        <ul class="list-unstyled small">
                            <li><strong>ID del procesamiento:</strong> {{ archivo_procesado.id }}</li>
                            <li><strong>Filas leídas:</strong> {{ archivo_procesado.filas_totales }}</li>
                            <li><strong>Columnas detectadas:</strong> {{ archivo_procesado.columnas_totales }}</li>
                            {% if hoja_seleccionada %}
                                <li><strong>Hoja específica:</strong> {{ hoja_seleccionada }}</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function mostrarInformacionTecnica() {
    const infoPanel = document.getElementById('info-tecnica');
    if (infoPanel.style.display === 'none') {
        infoPanel.style.display = 'block';
        infoPanel.scrollIntoView({ behavior: 'smooth' });
    } else {
        infoPanel.style.display = 'none';
    }
}

// Mejorar la apariencia de la tabla
document.addEventListener('DOMContentLoaded', function() {
    const tabla = document.querySelector('#archivo-tabla');
    if (tabla) {
        tabla.classList.add('table-sm');
        
        // Agregar numeración de filas
        const filas = tabla.querySelectorAll('tbody tr');
        filas.forEach((fila, index) => {
            const celdaNumero = document.createElement('td');
            celdaNumero.textContent = index + 1;
            celdaNumero.classList.add('text-muted', 'small');
            fila.insertBefore(celdaNumero, fila.firstChild);
        });
        
        // Agregar encabezado para la numeración
        const encabezado = tabla.querySelector('thead tr');
        if (encabezado) {
            const thNumero = document.createElement('th');
            thNumero.textContent = '#';
            thNumero.classList.add('text-muted');
            encabezado.insertBefore(thNumero, encabezado.firstChild);
        }
    }
});
</script>

<style>
#tabla-datos .table {
    margin-bottom: 0;
}

#tabla-datos .table th {
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    border-top: none;
}

.badge {
    font-size: 0.8em;
}

#info-tecnica {
    border: 1px dashed #dee2e6;
}
</style>
{% endblock %}